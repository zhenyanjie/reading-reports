## Dune: Safe User-level Access to Privileged CPU Features

[Dune: Safe User-level Access to Privileged CPU Features](https://www.usenix.org/system/files/conference/osdi12/osdi12-final-117.pdf)

### Summary of major innovations

本文主要介绍了Dune，它能够为普通用户程序提供了安全高效的访问特权CPU的功能，同时也保留现有的操作系统的接口。他用安全的方式对应用程序expose特权cpu功能，不用修改内核。dune 包括可加载的内核模块和libdune两部分。作者实现了基于x86 和linux的dune。

各种应用程序都可以受益于访问kern-only hardware features，为了实现这个目的，有两种方法，一种是修改内核，但是在实现中不安全，不稳定；一种是将应用程序捆绑到具有专用内核的虚拟机映像中，这种方比较安全，但是虚拟机与主机操作系统的集成差，实现专有内核页很复杂。

基于以上背景，本文介绍了一种应用程序使用内核硬件特性的新方法：使用虚拟化硬件提供一个进程，而不是一个机器抽象。 Dune提供了一个可加载的内核模块，可以与未修改的Linux内核一起工作。 该模块允许进程进入“Dune模式”，这是一种不可逆的转换，通过虚拟化硬件启用对特权硬件功能的安全和快速访问，包括特权模式，虚拟内存寄存器，页表和中断，异常和系统调用向量。 并且提供了一个用户级库libDune，以方便这些功能的使用。

Dune提供了优于虚拟机的几个优点。 首先，Dune进程是一个普通的Linux进程，唯一的区别是它使用VMCALL指令调用系统调用，而且Dune应用程序易于开发（是应用程序编程，而不是内核编程）。 第二，因为Dune内核模块不试图提供机器抽象，所以模块可以更简单和更快。 

### What the problems the paper mentioned

本文主要介绍了Dune的设计思路，并阐述了为何其性能是提高的，以及如何证明其性能提高了，并设计了三个应用程序 sandboxing，wedge 和垃圾回收来证明其性能的优越。

**1. 硬件基础**

dune实现的硬件基础是Intel 的VT-x， VT-x采用一种设计，将cpu分为root和非root两种模式，非root模式限制cpu行为，VMCS用于存储架构状态，包含大量配置参数，给予vmm在确定那些硬件expose给客户端方面比较大的灵活性。 虚拟内存是一个难点，EPT可以解决。

**2. Dune支持的硬件功能**

Dune使用VT-x为用户程序提供对x86保护硬件的完全访问。 这包括三个特权硬件功能：异常，虚拟内存和对特权模式的访问。使用dune比不使用性能有显著提高。

还有许多硬件功能，如高速缓存控制，调试寄存器等可以在未来的工作中实现。

**3. 内核模块部分**

Dune的核心是一个内核模块，管理VT-x和向用户程序提供对特权的硬件功能的访问

- 3.1 概述

  Dune通过一个使能了VT-x的模块来拓展内核，把内核放置在VMX root模式。进程使用Dune是在VMX 非root模式下，被授予直接但是安全的对特权硬件的访问。Dune模块拦截VM退出，这是Dune进程访问内核的唯一方法，并执行任何必要的操作，例如服务页面错误，调用系统调用或在HLT指令后释放CPU。

  Dune应用于需要它的进程，不使用Dune的进程完全不受影响，一旦进入Dune模式，进程不能退出Dune模式。每当Dune进程fork时，子进程不会在Dune模式下启动，但如果用例需要，可以重新进入Dune。

  本文还将dune与vmm做了比较，提出他们的四点不同。


- 3.2 内存管理

  本文还着重讲解了内存管理部分，内存管理的dune模块最大的责任之一。面临的挑战是直接页面表访问用户程序，同时防止任意访问物理内存。此外，dune的目标是默认提供一个正常的进程内存地址空间，允许用户程序只添加他们需要的功能，而不是完全替换内核级内存管理。


- 3.3 expose access to hardware

  Dune expose了对异常，虚拟内存和权限模式的访问。 异常和特权模式在VMX非root模式下是隐式可用的，不需要任何特殊配置。另一方面，虚拟内存需要访问％CR3寄存器，这可以在VMCS中授予。 我们为每个进程维护单独的VMCS，以允许每进程配置特权状态并且更容易和有效地支持上下文切换。

  x86包括确定启用哪些硬件特征的各种控制寄存器，虽然我们可以允许Dune进程直接配置这些，但是我们改为镜像由内核设置的配置。这使我们能够支持正常的过程环境; 允许许多配置更改将破坏与用户程序的兼容性。

  在某些情况下，由于性能原因，Dune限制对硬件寄存器的访问。

- 3.4 保留os接口

  除了暴露特权硬件功能之外，Dune还保留对OS系统调用的访问。

- 3.5 实现

  Dune目前支持在64位长模式下在Intel x86处理器上运行的Linux。可能在未来增加对AMD CPU和32位模式的支持。为了保持对内核的更改尽可能不干扰，作者开发了Dune作为动态可加载的内核模块。作者的实现部分基于KVM。 具体来说，它共享用于管理低级VT-x操作的代码。但是，高级代码不与KVM共享，因为Dune与VMM操作不同。

**4.用户模式环境**

dune 除了可加载的内核模块还包括一个libdune

libDune是一个库，使构建使用dune的应用程序更加简单。它完全不受内核的信任，由一组实用程序组成，有助于管理和配置特权硬件功能。libDune的主要组件包括页表管理器，ELF加载器，简单的页面分配器和帮助用户程序管理异常和系统调用的例程。

在许多方面，将进程转换到Dune模式类似于引导操作系统。

虽然我们能够运行各种各样的Linux程序，libDune仍然缺少一些功能。

在Dune环境中工作的一个意想不到的挑战是，系统调用参数必须是有效的主机 - 虚拟地址，而不管如何设置客户 - 虚拟映射；Dune引入的另一个挑战是，通过暴露对特权硬件的更大访问权限，用户程序需要更多的特定于体系结构的代码，从而潜在地降低了可移植性。

**5. 应用**

本文介绍了sandboxing，wedge 和垃圾回收 三个应用程序作为例子。

**6. 关于硬件的思考**

本文提出，对VT-x的一些硬件更改可能会有利于Dune。

并且提出了为了dune可以实现的一些特权硬件的支持，不仅限于异常，虚拟内存和对特权模式的访问。

### How about the important related works/papers

本文介绍了一些相关工作。

- 使应用程序能够更好的访问硬件的工作：Exokernel通过低级内核接口显示硬件功能，允许应用程序直接管理硬件资源。SPIN项目允许应用程序安全地将扩展直接加载到内核中。Dune也试图给应用程序更多的硬件访问。dune的不同之处在于它的目标不是可扩展性。相反，Dune提供对特权硬件特征的访问，使得它们可以与OS协同使用，而不是修改或重写它的手段。
- Fluke项目在软件中支持嵌套过程模型，允许OS“垂直”构建。Dune补充了这种方法，因为它可以用于通过使用特权模式硬件在应用程序和内核之间有效地支持额外的操作系统层。但是，Dune公开的硬件只能支持单个级别，而不是Fluke中提供的多个级别。
- sandboxing：ptrace——专用内核修改，二进制转换和二进制验证。Native Client 性能比dune差很多很多，但是更portable。

### How to test/compare/analyze the results?

本文介绍了作者验证dune性能优越的方法。

所有测试均在Intel Xeon E3-1230 v2（四核Ivy Bridge CPU时钟为3.3 GHz）和16GB RAM的单插槽计算机上执行。使用安装了最新的64位版本的Debian Linux，其中包括Linux内核版本3.2。 电源管理功能（例如频率缩放）已禁用。

Dune的性能受到两个主要开销来源的影响：首先，VT-x增加了进入和退出内核-VM条目的成本，并且VM出口比快速系统调用。指令或异常更昂贵。因此，系统调用和其他类型的故障（例如，页错误）必须在Dune中支付固定成本。第二，使用EPT使得TLB错过更昂贵，因为在一些情况下，hardware page walker必须遍历两个页表而不是一个页表。

文章建立了综合基准来测量这两种效应，建立了一个表（表2）展示了系统调用，页面故障和访问页表的开销。对于系统调用，作者手动执行getpid，一个基本上为空的系统调用（Dune的最坏情况），并测量往返延迟；对于页面故障，作者测量了内核在预先归零的内存页中发生故障所需的时间；对于页表访问，作者测量了填充TLB未命中所花费的时间。

直接访问特权硬件会带来很多优化，作者展示了在ptrace、trap、appel1和appel2几个方面带来的加速效果。

作者还针对三个应用程序分别进行了测试，以证明dune的高性能。





翻译了论文的一部分：[translation of this paper](https://github.com/zhenyanjie/reading-reports/blob/master/Dune:%20Safe%20User-level%20Access%20to%20Privileged%20CPU%20Features/translation-Dune:%20Safe%20User-level%20Access%20to%20Privileged%20CPU%20Features.md)





